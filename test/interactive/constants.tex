\documentclass{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{hyperref}
\usepackage[margin=1in]{geometry}

\title{Stable, efficient evaluation of gradients and Hessians for the Rician log-likelihood}
\author{Jonathan Doucette}
\date{\today}

\begin{document}
\maketitle

\section{Introduction}

We consider the Rician probability density for a positive observation $x>0$ with noncentrality parameter $\nu>0$ and scale $\sigma>0$.
The pdf is
%
\begin{align}
  p(x\mid\nu,\sigma) = \frac{x}{\sigma^2} \exp\left(-\frac{x^2+\nu^2}{2\sigma^2}\right) I_0\left(\frac{x\nu}{\sigma^2}\right)
\end{align}
%
where $I_0$ is the modified Bessel function of the first kind of order zero.

We seek numerically stable, machine-precision formulas for the negative log-likelihood and its first- through third-order partial derivatives with respect to $x$ and $\nu$.
Define $F(x,\nu,\sigma) := -\log p(x\mid\nu,\sigma)$ and $f(x,\nu) := F(x,\nu,1)$.
For general $\sigma>0$, set $x'=x/\sigma$ and $\nu'=\nu/\sigma$.
Then, we have
%
\begin{align}
  F(x,\nu,\sigma) = f(x',\nu') + \log\sigma
\end{align}
%
and the derivatives of $F$ with respect to $x$, $\nu$, and $\sigma$ are given in terms of the derivatives of $f$:
%
\begin{align}
  \frac{\partial F}{\partial x}      = \frac{1}{\sigma} \frac{\partial f}{\partial x'}                                                                                        \qquad
  \frac{\partial F}{\partial \nu}    = \frac{1}{\sigma} \frac{\partial f}{\partial \nu'}                                                                                      \qquad
  \frac{\partial F}{\partial \sigma} = -\frac{x}{\sigma^2} \frac{\partial f}{\partial x'} - \frac{\nu}{\sigma^2} \frac{\partial f}{\partial \nu'} + \frac{1}{\sigma}
\end{align}
%
and likewise for higher-order derivatives.

Henceforth we take $\sigma=1$ and, by slight abuse of notation, write $x,\nu$ for the rescaled variables $x',\nu'$.
We will show that the key to numerically stable evaluation of $f$ and its derivatives is to carefully consider the limiting behavior in the regimes where $z = x\nu \ll 1$ and $z \gg 1 \Leftrightarrow u=1/z \ll 1$.
Na\"ive differentiation produces expressions with catastrophic cancellation in both regimes.
To evaluate $f$ and its derivatives in a numerically stable way, we branch on the value of $z$ and derive algebraic simplifications in each branch.

\section{The Rician log-likelihood and basic simplifications}

With $\sigma=1$, the Rician negative log-likelihood is given by
%
\begin{align}
  f(x,\nu) & = -\log p(x\mid\nu)                                                                                               \\
           & = \frac{(x-\nu)^2}{2} - \frac{1}{2}\log\left(\frac{x}{\nu}\right) - \log \hat{I}_0(x \nu) + \frac{1}{2}\log(2\pi)
\end{align}
%
where $\hat{I}_0$ is the scaled modified Bessel function of the first kind
%
\begin{align}
  \hat{I}_0(z) = \frac{I_0(z)}{e^{z}/\sqrt{2\pi z}}.
\end{align}

\subsection{First derivatives}

Now, we differentiate $f$ with respect to $x$ and $\nu$ and simplify algebraically:
%
\begin{align}
  f_x   & = x-\nu -\frac{1}{2x} - \nu\frac{d}{dz}\log\hat{I}_0(z) \label{eq:first-derivatives-unsimplified-x}  \\
  f_\nu & = \nu-x +\frac{1}{2\nu} - x\frac{d}{dz}\log\hat{I}_0(z) \label{eq:first-derivatives-unsimplified-nu}
\end{align}
%
where
%
\begin{align}
  \frac{d}{dz}\log\hat{I}_0(z) & = r(z) - 1 + \frac{1}{2z} \label{eq:log-scaled-bessel-derivative} \\
  r(z)                         & = \frac{I_1(z)}{I_0(z)}. \label{eq:ratio-r}
\end{align}
%
Substituting~\eqref{eq:log-scaled-bessel-derivative} and $z=x\nu$ into~\eqref{eq:first-derivatives-unsimplified-x} and~\eqref{eq:first-derivatives-unsimplified-nu} gives
%
\begin{align}
  f_x   & = x - \nu r - \frac{1}{x} \label{eq:first-derivatives-simplified-x} \\
  f_\nu & = \nu - x r \label{eq:first-derivatives-simplified-nu}
\end{align}

\subsection{Second derivatives}

Next, we differentiate the simplified first derivatives~\eqref{eq:first-derivatives-simplified-x} and~\eqref{eq:first-derivatives-simplified-nu} to obtain the second derivatives:
%
\begin{align}
  f_{xx}     & = \frac{\partial}{\partial x}\left(x - \nu r(z) - \frac{1}{x}\right) = 1 + \frac{1}{x^2} - \nu^2 r' \label{eq:second-derivatives-unsimplified-x-x} \\
  f_{x\nu}   & = \frac{\partial}{\partial \nu}\left(x - \nu r(z) - \frac{1}{x}\right) = -(r + z r') = -z(1 - r^2) \label{eq:second-derivatives-unsimplified-x-nu} \\
  f_{\nu\nu} & = \frac{\partial}{\partial \nu}\left(\nu - x r(z)\right) = 1 - x^2 r' \label{eq:second-derivatives-unsimplified-nu-nu}
\end{align}
%
where the last equality in~\eqref{eq:second-derivatives-unsimplified-x-nu} follows from the recurrence relation~\eqref{eq:r-prime-recurrence}.

\subsection{Third derivatives}

Differentiate once more to obtain third derivatives; each depends only on $r'$ and $r''$:
%
\begin{align}
  f_{xxx}       & = \frac{\partial}{\partial x}\left(1+\frac{1}{x^2}-\nu^2 r'(z)\right) = -\frac{2}{x^3} - \nu^3 r'' \label{eq:third-derivatives-unsimplified-x-x-x}                                 \\
  f_{xx\nu}     & = \frac{\partial}{\partial \nu}\left(1+\frac{1}{x^2}-\nu^2 r'(z)\right) = -2\nu r' - x\nu^2 r'' = -\nu(2r' + z r'')              \label{eq:third-derivatives-unsimplified-x-x-nu}  \\
  f_{x\nu\nu}   & = \frac{\partial}{\partial x}\left(1 - x^2 r'(z)\right) = -2x r' - x^2\nu r'' = -x(2r' + z r'')                                  \label{eq:third-derivatives-unsimplified-x-nu-nu} \\
  f_{\nu\nu\nu} & = \frac{\partial}{\partial \nu}\left(1 - x^2 r'(z)\right) = -x^3 r''. \label{eq:third-derivatives-unsimplified-nu-nu-nu}
\end{align}
%
Therefore it suffices to compute $r$, $r'$, and $r''$ with high relative accuracy.

\section{Recurrence relations for derivatives of $r$}

To obtain $r$, $r'$, and $r''$, we differentiate $r=I_1/I_0$.
Using $I_0'=I_1$ and $I_1'=I_0 - I_1/z$, we have the recurrence relations
%
\begin{align}
  r'  & = \frac{I_1'}{I_0} - r\frac{I_0'}{I_0} = \frac{I_0 - \frac{1}{z} I_1}{I_0} - r^2 = 1 - \frac{r}{z} - r^2 \label{eq:r-prime-recurrence}                                           \\
  r'' & = -\left(\frac{r}{z}\right)' - 2 r r' = -\frac{r'}{z} + \frac{r}{z^2} - 2 r r' = 2 r (r^2 - 1) + \frac{3 r^2 - 1}{z} + \frac{2 r}{z^2} \label{eq:r-second-derivative-recurrence}
\end{align}

These are exact identities but are numerically unstable as $z \to 0$ and as $z \to \infty$.
To address this, for each of $r$, $r'$, and $r''$, we split the domain $z>0$ into three regimes and approximate a single well-scaled quantity in each regime:
\begin{itemize}
  \item Small $z$: use a Taylor expansion, group terms by order in $z$, and fit a minimax polynomial to the residual.
  \item Large $z$: use the asymptotic expansion in $u = 1/z$, group terms by order in $u$, and fit a minimax polynomial to the residual.
  \item Intermediate $z$: cancellation is negligible; employ a rational minimax approximant.
\end{itemize}

\section{Small-$z$ analysis}

For small $z$, $r \approx z/2$.
Thus if we define
%
\begin{align}
  a_0(z) = \frac{r(z)}{z} = \frac{1}{2} - \frac{1}{16}z^2 + \mathcal{O}(z^4),
\end{align}
%
then for computing $r$, we need only approximate $a_0$ to high precision.
Similarly, to compute $r'$, we have
%
\begin{align}\label{eq:r-prime-reparametrized}
  r'(z) = 1 - \frac{r}{z} - r^2 = 1 - a_0 - z^2 a_0^2
\end{align}
%
which is numerically stable since $a_0 = \frac{1}{2} + \mathcal{O}(z^2)$ and thus both the constant coefficient $1 - a_0$ and the quadratic coefficient $-a_0^2$ do not suffer from cancellation in floating-point arithmetic.

However, the second derivative $r''$ requires more care.
Observe that
%
\begin{align}
  r''(z) & = -\frac{r'}{z} + \frac{r}{z^2} - 2 r r'                                             \\
         & = -\frac{1 - a_0 - z^2 a_0^2}{z} + \frac{z a_0}{z^2} -  2 z a_0(1 - a_0 - z^2 a_0^2) \\
         & = \frac{2 a_0 - 1}{z} + z a_0 (3 a_0 - 2) + 2 z^3 a_0^3.
\end{align}
%
The leading $\mathcal{O}(1/z)$ term has coefficient $2a_0 - 1$, but for small $z$, $a_0 \approx \frac{1}{2} - \frac{1}{16}z^2$ and thus computing $2a_0 - 1$ requires subtracting two $\mathcal{O}(1)$ terms to obtain a $\mathcal{O}(z^2)$ term.
We therefore reparametrize to
%
\begin{align}
  a_0                 & = \frac{1}{2} + z^2 a_1 \label{eq:a0-reparametrized}                                                          \\
  \Leftrightarrow a_1 & = \frac{1}{z^2} (a_0 - \frac{1}{2}) = \frac{1}{z^2} (\frac{r}{z} - \frac{1}{2}). \label{eq:a1-reparametrized}
\end{align}
%
Note that since $r = \frac{1}{2}z - \frac{1}{16}z^3 + \mathcal{O}(z^5)$, it follows that $a_1 = -\frac{1}{16} + \mathcal{O}(z^2)$.
We can then rewrite the second derivative into a numerically stable form:
%
\begin{align}
  r''(z) & = \frac{2(\frac{1}{2} + z^2 a_1)-1}{z} + z a_0 (3 a_0 - 2) + 2 z^3 a_0^3                 \\
         & = z (2a_1 + a_0 (3 a_0 - 2)) + 2 z^3 a_0^3 \label{eq:r-second-derivative-reparametrized}
\end{align}
%
We also note that the quantity $2r' + z r''$ from equations~\eqref{eq:third-derivatives-unsimplified-x-x-nu} and
\eqref{eq:third-derivatives-unsimplified-x-nu-nu} does not suffer cancellation issues, since $2r' = 1 + \mathcal{O}(z^2)$ and $z r'' = \mathcal{O}(z^2)$.

Thus, we need only fit one minimax polynomial to equation~\eqref{eq:a1-reparametrized} to estimate $a_1(z)$, and then $r$, $r'$, and $r''$ can be formed from $a_1$ and $a_0 = \frac{1}{2} + z^2 a_1$ without catastrophic cancellation using equations~\eqref{eq:r-prime-reparametrized} and~\eqref{eq:r-second-derivative-reparametrized}.

% We can then rewrite the first and second derivatives of $r$ as
% %
% \begin{align}
%   r'(z) & = 1 - a_0 - z^2 a_0^2 \\
%   & = 1 - (\frac{1}{2} + z^2 a_1) - z^2 (\frac{1}{2} + z^2 a_1)^2 \\
%   &= \frac{1}{2} - z^2 (a_1 + \frac{1}{4}) - z^4 a_1 - z^6 a_1^2
% \end{align}
% %
% \begin{align}
%   r''(z) & = \frac{2 a_0 - 1}{z} + z a_0 (3 a_0 - 2) + 2 z^3 a_0^3 \\
%   &= \frac{2(\frac{1}{2} + z^2 a_1)-1}{z} - 2z(\frac{1}{2} + z^2 a_1) + 2z(\frac{1}{2} + z^2 a_1)^{2} + 2z^3 (\frac{1}{2} + z^2 a_1)^3 \\
%          & = z (2a_1 - \frac{1}{2}) + \frac{1}{4} z^3 + z^5 a_1 (\frac{3}{2} + 2 a_1) + z^7 (3 a_1^2) + z^9 (2 a_1^3)
% \end{align}

% Finally, we see from equations~\eqref{eq:third-derivatives-unsimplified-x-x-nu} and
% \eqref{eq:third-derivatives-unsimplified-x-nu-nu} that we should double-check the quantity $2r' + zr''$ for cancellation issues:
% %
% \begin{align}
%   2r' + zr'' & = 2(1 - a_0 - z^2 a_0^2) + z(z (2a_1 + a_0 (3 a_0 - 2)) + 2 z^3 a_0^3) \\
%              & = 2 - 2a_0 - 2z^2 a_0^2 + z^2 (2a_1 + a_0 (3 a_0 - 2)) + 2 z^4 a_0^3 \\
%              & = 2 a_0^3 z^4 + a_0^2 z^2 - 2 a_0 z^2 - 2 a_0 + 2 a_1 z^2 + 2 \\
%              & = 2 - 2a_0 + z^2 (2a_1 - a_0 (2 - a_0)) + 2 a_0^3 z^4
% \end{align}

\section{Large-$z$ analysis}

As $z \to \infty$, $r \to 1$.
To avoid cancellation issues analogous to the small-$z$ case, we work with $u=1/z$ and rescale the residual $1-r$ to obtain a well-scaled quantity.
Let
%
\begin{align}
  b_0(u)           & = \frac{1-r(z)}{u} = \frac{1}{2} + \frac{1}{8} u + \frac{1}{8} u^2 + \mathcal{O}(u^3) \\
  \Rightarrow r(z) & = 1 - u b_0(u) \label{eq:r-large-reparametrized}
\end{align}
%
Approximating $b_0$ with a minimax polynomial allows us to compute $r$ without catastrophic cancellation.

Next, we consider $r'$:
%
\begin{align}
  r'(z) & = 1 - \frac{r}{z} - r^2                                                     \\
        & = 1 - u(1 - u b_0) - (1 - u b_0)^2                                          \\
        & = u (2 b_0 - 1) + u^2 b_0 (1 - b_0) \label{eq:r-prime-large-reparametrized}
\end{align}
%
Analogous to the small-$z$ case, this will lead to cancellation issues since $2b_0 - 1 = \mathcal{O}(u)$.
Thus, we reparametrize to
%
\begin{align}
  b_1(u)             & = \frac{2b_0(u)-1}{u} = \frac{1}{4} + \frac{1}{4} u + \mathcal{O}(u^2) \\
  \Rightarrow b_0(u) & = \frac{1 + u b_1(u)}{2}
\end{align}
%
Then, $r'$ simplifies to
%
\begin{align}\label{eq:r-prime-large-reparametrized-simplified}
  r' = u(2b_0-1) + u^2 b_0(1-b_0) = u^2 (b_1 + b_0(1-b_0))
\end{align}
%
which avoids cancellation issues since $b_1 \to \frac{1}{4}$ and $b_0 \to \frac{1}{2}$ as $u \to 0$, thus $r' = \frac{1}{2} u^2 + \mathcal{O}(u^3)$.

Next, we consider $r''$:
%
\begin{align}
  r'' & = -\frac{r'}{z} + \frac{r}{z^2} - 2 r r'                                                \\
      & = -u(u^2 (b_1 + b_0(1-b_0))) + u^2 (1 - u b_0) - 2 (1 - u b_0) (u^2 (b_1 + b_0(1-b_0))) \\
      & = u^2 (2b_0^2 - 2b_1 - (2b_0 - 1)) + u^3 (b_1 (2b_0 - 1) - 2b_0 + 3b_0^2 - 2b_0^3)      \\
      & = u^2 (2b_0^2 - 2b_1) + u^3 (b_0 (- 2 + 3b_0 - 2b_0^2) - b_1) + u^4 b_1^2               \\
      & = u^2 (2b_0^2 - 2b_1) + u^3 (b_0 (2(2b_0 - 1) - b_0 (1 + 2b_0)) - b_1) + u^4 b_1^2      \\
      & = u^2 (2b_0^2 - 2b_1) - u^3 (b_0^2 (1 + 2b_0) + b_1) + u^4 b_1(b_1 + 2b_0)
\end{align}
%
Now, since $b_0 = \frac{1}{2} + \mathcal{O}(u)$ and $b_1 = \frac{1}{4} + \mathcal{O}(u)$, we have $b_0^2 - b_1 = \mathcal{O}(u)$, and thus the leading term is order $\mathcal{O}(u^3)$, as expected since $r = 1 + \mathcal{O}(1/z)$.
To avoid cancellation issues, we introduce one final change of variables:
%
\begin{align}
  b_2(u)             & = \frac{4 b_1(u) - 1}{u} = 1 + \mathcal{O}(u) \label{eq:b2-reparametrized} \\
  \Rightarrow b_1(u) & = \frac{1 + u b_2(u)}{4} \label{eq:b1-reparametrized}
\end{align}
%
Then, we have
%
\begin{align}
  2b_0^2 - 2b_1 & = 2(\frac{1 + u b_1}{2})^2 - 2b_1 = \frac{1}{2} (1 - 4 b_1 + 2 u b_1 + u^2 b_1^2) \\
                & = \frac{1}{2} u (-b_2 + 2 b_1) + \frac{1}{2} u^2 b_1^2
\end{align}
%
and finally
%
\begin{align}
  r'' & = u^2 (2b_0^2 - 2b_1) - u^3 (b_0^2 (1 + 2b_0) + b_1) + u^4 b_1(b_1 + 2b_0)                                                        \\
      & = \frac{1}{2} u^2 (u (-b_2 + 2 b_1) + u^2 b_1^2) - u^3 (b_0^2 (1 + 2b_0) + b_1) + u^4 b_1(b_1 + 2b_0)                             \\
      & = -u^3 (\frac{1}{2}b_2 + b_0^2 (1 + 2b_0)) + u^4 b_1 (\frac{3}{2} b_1 + 2b_0) \label{eq:r-second-derivative-large-reparametrized}
\end{align}

Thus, we need only fit one minimax polynomial to equation~\eqref{eq:b2-reparametrized} to estimate $b_2(u)$, and then $r$, $r'$, and $r''$ can be formed from $b_2$, $b_1 = \frac{1 + u b_2}{4}$, and $b_0 = \frac{1 + u b_1}{2}$ using equations~\eqref{eq:r-prime-large-reparametrized} and~\eqref{eq:r-second-derivative-large-reparametrized} without catastrophic cancellation.

% \section{Intermediate-$z$ analysis}
%
% TODO?

\section{Further Rician derivative simplifications}

\subsection{First derivatives}

\paragraph{Small-$z$}

The algebraic simplification of equations~\eqref{eq:first-derivatives-unsimplified-x} and~\eqref{eq:first-derivatives-unsimplified-nu} leading to equations~\eqref{eq:first-derivatives-simplified-x} and~\eqref{eq:first-derivatives-simplified-nu} is sufficient to avoid catastrophic cancellation.
In particular, when $\nu \ll 1$, the problematic $\frac{1}{2\nu}$ and $\frac{-x}{2z} = \frac{-1}{2\nu}$ terms in~\eqref{eq:first-derivatives-unsimplified-nu} are cancelled analytically, avoiding subtraction of two $\mathcal{O}(1/\nu)$ terms.
%
\begin{align}\label{eq:first-derivatives-small-z}
  \boxed{%
    \begin{aligned}
      f_x   & = x - \nu r - \frac{1}{x} \\
      f_\nu & = \nu - x r
    \end{aligned}}
\end{align}

\paragraph{Large-$z$}

For $z \gg 1$, we have $r = 1 - b_0(1/z) / z$ from equation~\eqref{eq:r-large-reparametrized}, resulting in
%
\begin{align}
  f_x   & = x - \nu (1 - \frac{b_0}{z}) - \frac{1}{x}
  = x - \nu - \frac{1 - b_0}{x}                       \\
  f_\nu & = \nu - x (1 - \frac{b_0}{z})
  = \nu - x + \frac{b_0}{\nu}
\end{align}
%
These forms of $f_x$ and $f_\nu$ are more numerically
stable when $x \approx \nu \approx \sqrt{z}$.
This is a common case in practice when the signal-to-noise ratio (SNR) is large: observations concentrate near the noncentrality parameter, i.e. $x \approx \nu \pm 1$ (recall that the noise level is normalized to $\sigma=1$).
The improved numerical stability results from the approximation error being scaled by $1/x$ and $1/\nu$ instead of by $\nu$ and $x$.
If $\hat{r}=r(1+\delta_r)$ and $\hat{b}_0=b_0(1+\delta_b)$, the naive forms incur absolute errors $\mathcal{O}(\nu|\delta_r|)$ in $f_x$ and $\mathcal{O}(x|\delta_r|)$ in $f_\nu$, whereas the simplified forms incur errors $\mathcal{O}(|\delta_b|/x)$ and $\mathcal{O}(|\delta_b|/\nu)$.
Since $z = x\nu \gg 1$ and the relative errors $|\delta_r|$ and $|\delta_b|$ are comparably small, this yields an absolute-error reduction approximately by a factor of $z$.
%
%
\begin{align}\label{eq:first-derivatives-large-z}
  \boxed{%
    \begin{aligned}
      f_x   & = x - \nu - \frac{1 - b_0}{x} \\
      f_\nu & = \nu - x + \frac{b_0}{\nu}
    \end{aligned}}
\end{align}

\subsection{Second derivatives}

\paragraph{Small-$z$}

Similar to the first derivatives, the algebraically simplified equations~\eqref{eq:second-derivatives-unsimplified-x-x}, \eqref{eq:second-derivatives-unsimplified-x-nu}, and \eqref{eq:second-derivatives-unsimplified-nu-nu} are sufficient to avoid catastrophic cancellation.
%
%
\begin{align}\label{eq:second-derivatives-small-z}
  \boxed{%
    \begin{aligned}
      f_{xx}     & = 1 + \frac{1}{x^2} - \nu^2 r' \\
      f_{x\nu}   & = -z (1 - r^2)                 \\
      f_{\nu\nu} & = 1 - x^2 r'
    \end{aligned}}
\end{align}
%
Here $r= z a_0$ and $r' = 1-a_0 - z^2 a_0^2$, with $1-a_0=\frac{1}{2}+\mathcal{O}(z^2)$ and $z^2 a_0^2=\mathcal{O}(z^2)$, so no catastrophic cancellation occurs.
The cross term may use either $-z(1-r^2)$ or $-(r+z r')$:
since $r \approx z/2$ and $zr' \approx z/2$, the former subtracts terms of different magnitudes, and the latter adds terms of the same magnitude but whose leading terms do not suffer cancellation issues.

\paragraph{Large-$z$}

We start by rewriting the forms of the second derivatives expressions~\eqref{eq:second-derivatives-unsimplified-x-x}, \eqref{eq:second-derivatives-unsimplified-x-nu}, and \eqref{eq:second-derivatives-unsimplified-nu-nu} for stability at large-$z$:
%
\begin{align}
  f_{xx}     & = 1 + \frac{1}{x^2} - \nu^2 r' = 1 + \frac{1}{x^2}(1 - z^2 r') \\
  f_{x\nu}   & = -z(1 - r^2) = -z (1 - r) (1 + r)                             \\
  f_{\nu\nu} & = 1 - x^2 r'
\end{align}
%
Recall that for large-$z$, we have from~\eqref{eq:r-large-reparametrized} and~\eqref{eq:r-prime-large-reparametrized-simplified} that
\begin{align}
  r                      & = 1 - \frac{b_0}{z} = 1 - \frac{1}{2z} - \frac{1}{8z^2} + \mathcal{O}(1/z^3)                \\
  r'                     & = \frac{1}{z^2} (b_1 + b_0(1 - b_0)) = \frac{1}{2z^2} + \frac{1}{4z^3} + \mathcal{O}(1/z^4) \\
  \Rightarrow z(1 - r^2) & = r + z r' = 1 + \frac{1}{z} (b_1 - b_0^2) = 1 + \frac{1}{8z^2} + \mathcal{O}(1/z^3)
\end{align}
where $b_0 = \frac{1}{2} (1 + u b_1)$.
%
We make the following observations:
%
\begin{itemize}
  \item $f_{xx}$: since $z^2 r' \approx \frac{1}{2}$, $1 - z^2 r'$ has no cancellation issues and $f_{xx} \approx 1 + \frac{1}{2x^2}$.
  \item $f_{\nu\nu}$: we have that $x^2 r' \approx \frac{x^2}{2z^2} = \frac{1}{2\nu^2}$; this also has no cancellation issues, and $f_{\nu\nu} \approx 1 - \frac{1}{2\nu^2}$.
  \item $f_{x\nu}$: $1 + r$ is stable to compute, but we must rewrite $z(1 - r) = b_0$ to avoid cancellation, so $f_{x\nu} = -b_0(1 + r) \approx -1 - \frac{1}{8z^2}$.
\end{itemize}
%
and therefore the stable forms are:
%
\begin{align}\label{eq:second-derivatives-large-z}
  \boxed{%
    \begin{aligned}
      f_{xx}     & = 1 + \frac{1}{x^2}(1 - z^2 r') \\
      f_{x\nu}   & = -b_0 (1 + r)                  \\
      f_{\nu\nu} & = 1 - x^2 r'
    \end{aligned}}
\end{align}

% \subsubsection{Error analysis}
%
% Following the large-$z$ analysis for the first derivatives, we substitute $r = 1 - \frac{b_0}{z}$ from~\eqref{eq:r-large-reparametrized} and $r' = \frac{1}{z^2} (b_1 + b_0(1 - b_0))$ from~\eqref{eq:r-prime-large-reparametrized-simplified} into the second derivatives expressions~\eqref{eq:second-derivatives-unsimplified-x-x}, \eqref{eq:second-derivatives-unsimplified-x-nu}, and \eqref{eq:second-derivatives-unsimplified-nu-nu}:
% %
% \begin{align}\label{eq:second-derivatives-large-z}
%   \boxed{%
%     \begin{aligned}
%       f_{xx}     & = 1 + \frac{1 - (b_1 + b_0(1-b_0))}{x^2} \\
%       f_{x\nu}   & = -b_0 (2 - \frac{b_0}{z})               \\
%       f_{\nu\nu} & = 1 - \frac{b_1 + b_0(1-b_0)}{\nu^2}
%     \end{aligned}}
% \end{align}
% %
% To analyze the error propagation, let $\hat{r}=r(1+\delta_r)$, $\hat{r}' = r'(1+\delta_{r'})$, $\hat{b}_0=b_0(1+\delta_{b_0})$, and $\hat{b}_1=b_1(1+\delta_{b_1})$ with comparable small relative errors.
% For the naive forms, we have
% %
% \begin{align}
%   |\hat{f}_{xx} - f_{xx}|         & = \nu^2 |\hat{r}' - r'| = \nu^2 |r'| |\delta_{r'}| \sim \nu^2 \frac{1}{z^2} |\delta_{r'}| = \frac{|\delta_{r'}|}{x^2}      \\
%   |\hat{f}_{\nu\nu} - f_{\nu\nu}| & = x^2 |\hat{r}' - r'| = x^2 |r'| |\delta_{r'}| \sim x^2 \frac{1}{z^2} |\delta_{r'}| = \frac{|\delta_{r'}|}{\nu^2}          \\
%   |\hat{f}_{x\nu} - f_{x\nu}|     & = |\hat{r} + z\hat{r}' - (r + zr')| \le |r| |\delta_r| + z |r'| |\delta_{r'}| \sim |\delta_r| + \frac{1}{z} |\delta_{r'}|.
% \end{align}
% %
% Next, the stable large-$z$ forms:
% Let $c = b_1 + b_0(1 - b_0)$ so that $f_{xx} = 1 + (1-c)/x^2$ and $f_{\nu\nu} = 1 - c/\nu^2$.
% Then, we have that:
% %
% \begin{align}
%   \hat{c} - c & = (\hat{b}_1 - b_1) + (\hat{b}_0 - b_0) - (\hat{b}_0^2 - b_0^2)             \\
%               & = b_1 \delta_{b_1} + b_0 \delta_{b_0} - b_0 \delta_{b_0} (\hat{b}_0 + b_0).
% \end{align}
% %
% This yields the first-order error bounds:
% %
% \begin{align}
%   |\hat{f}_{xx} - f_{xx}|         & = | \frac{c - \hat{c}}{x^2} | \lesssim \frac{|b_1| |\delta_{b_1}| + |b_0| (1 + |\hat{b}_0 + b_0|) |\delta_{b_0}|}{x^2}     \\
%   |\hat{f}_{\nu\nu} - f_{\nu\nu}| & = | \frac{c - \hat{c}}{\nu^2} | \lesssim \frac{|b_1| |\delta_{b_1}| + |b_0| (1 + |\hat{b}_0 + b_0|) |\delta_{b_0}|}{\nu^2} \\
%   |\hat{f}_{x\nu} - f_{x\nu}|     & = | 2 (b_0 - \hat{b}_0) + \frac{\hat{b}_0^2 - b_0^2}{z} | \le 2 (|b_0| + \frac{|b_0||\hat{b}_0 + b_0|}{z}) |\delta_{b_0}|.
% \end{align}

\subsection{Third derivatives}

\paragraph{Small-$z$}

We begin by noting that the third derivative expressions from~\eqref{eq:third-derivatives-unsimplified-x-x-x}--\eqref{eq:third-derivatives-unsimplified-nu-nu-nu} depend only on $r'$ and $r''$.
Recall the small-$z$ parametrizations for $r'$ and $r''$ from~\eqref{eq:r-prime-reparametrized} and~\eqref{eq:r-second-derivative-reparametrized}:
%
\begin{align}
  r'                      & = 1 - a_0 - z^2 a_0^2 = \frac{1}{2} - \frac{3}{16}z^2 + \mathcal{O}(z^4)                          \\
  r''                     & = z (2a_1 + a_0 (3 a_0 - 2)) + 2 z^3 a_0^3 = -\frac{3}{8}z + \mathcal{O}(z^3)                     \\
  \Rightarrow 2r' + z r'' & = 2 (1 - a_0) + (a_0 (a_0 - 2) + 2 a_1) z^2 + 2 a_0^3 z^4 = 1 - \frac{3}{4}z^2 + \mathcal{O}(z^3)
\end{align}
%
where $a_0 = \frac{r}{z}$ and $a_1 = \frac{1}{z^2} (a_0 - \frac{1}{2})$.
We see that for small-$z$, the original simplified expressions~\eqref{eq:third-derivatives-unsimplified-x-x-x}--\eqref{eq:third-derivatives-unsimplified-nu-nu-nu}
%
\begin{align}
  \boxed{%
    \begin{aligned}
      f_{xxx}       & = -\frac{2}{x^3} - \nu^3 r'' \\
      f_{xx\nu}     & = -\nu(2r' + z r'')          \\
      f_{x\nu\nu}   & = -x(2r' + z r'')            \\
      f_{\nu\nu\nu} & = -x^3 r''
    \end{aligned}}
\end{align}
%
are stable to compute, since neither $r''$ nor $2r' + z r''$ suffer cancellation issues.

\paragraph{Large-$z$}

For large $z$, the expression for $r''$ from~\eqref{eq:r-second-derivative-large-reparametrized} is stable.
The term $2r'+zr''$ is more delicate.
We derive a stable form from the identity $2r' + zr'' = r' + r/z - 2zrr'$ which follows from~\eqref{eq:r-prime-large-reparametrized-simplified} and~\eqref{eq:r-second-derivative-large-reparametrized}.
Substituting $r=1-ub_0$ and $r'=u^2(b_1+b_0(1-b_0))$ gives
%
\begin{align}
  2r' + zr'' &= r' + r/z - 2zrr' \\
            &= u^2 (b_1+b_0(1-b_0)) + u(1-ub_0) - 2u(1-ub_0)(b_1+b_0(1-b_0)) \\
             &= u ( u(b_1+b_0-b_0^2) + (1-ub_0)(1 - 2(b_1+b_0-b_0^2)) )
\end{align}
%
The term $1-2(b_1+b_0-b_0^2) = -\frac{1}{2}u + \mathcal{O}(u^2)$ contains a cancellation which can be resolved by substituting $b_0=(1+ub_1)/2$ followed by $b_1=(1+ub_2)/4$:
%
\begin{align}
  1-2(b_1+b_0-b_0^2) = \frac{1-4b_1+u^2b_1^2}{2} = -\frac{1}{2}u(b_2 - u b_1^2)
\end{align}
%
Substituting this back yields
%
\begin{align}
  2r' + zr'' &= u^2 ( (b_1+b_0-b_0^2) + (1-ub_0)\frac{u b_1^2 - b_2}{2} ) \\
  &= \frac{1}{2} u^2 ( (1-b_2) + u (b_2 (\frac{1}{2}+b_0 ) + b_1^2 ) - u^2 b_1^2 (\frac{1}{2} + b_0 ) )
\end{align}
%
but now, since $b_2 = 1 + \mathcal{O}(u)$, the term $1-b_2$ causes cancellation issues and so we must define one final change of variables $b_2 = 1 + u b_3$ to handle the cancellation.
Substituting this gives the stable form:
%
\begin{align}
  2r' + zr'' &= \frac{1}{2} u^2 ( -u b_3 + u (b_2 (\frac{1}{2}+b_0 ) + b_1^2 ) - u^2 b_1^2 (\frac{1}{2} + b_0 ) ) \\
             &= \frac{1}{2} u^3 ( b_2 (\frac{1}{2}+b_0 ) + b_1^2 - b_3) - \frac{1}{2} u^4 b_1^2 (\frac{1}{2} + b_0) \label{eq:2rprime-zrsecondprime-large-z}
\end{align}
%
This expression is $\mathcal{O}(u^3)$ with no remaining cancellation issues.
All terms are computed from $b_0, b_1, b_2$, and $b_3$, which depend on a single minimax approximation for $b_3(u)$.

With these stable forms, the third derivatives for large $z$ are computed as:
\begin{align}\label{eq:third-derivatives-large-z}
  \boxed{%
    \begin{aligned}
      f_{xxx}       & = -\frac{2}{x^3} - \nu^3 r'' \\
      f_{xx\nu}     & = -\frac{1}{2 x z^2}   ( b_1^2 - b_3 + (b_2  - \frac{1}{z} b_1^2) (\frac{1}{2} + b_0))         \\
      f_{x\nu\nu}   & = -\frac{1}{2 \nu z^2} ( b_1^2 - b_3 + (b_2  - \frac{1}{z} b_1^2) (\frac{1}{2} + b_0))           \\
      f_{\nu\nu\nu} & = -x^3 r''
    \end{aligned}}
\end{align}

\section{Conclusion}

In summary, by expressing derivatives in terms of $r=I_1/I_0$ and carefully reparametrizing in the small- and large-$z$ regimes, we obtain numerically stable formulas for $f$ and its first three derivatives across all $z>0$.

\end{document}
